<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Newton and Gravity</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Luckiest+Guy&display=swap');

        :root {
            --magic-teal: #76ffeb;
            --deep-energy: #1de9b6;
            --log-brown: #3e2723;
        }

        body { 
            margin: 0; text-align: center; font-family: 'Luckiest Guy', cursive; 
            background: #0d1f0d; overflow: hidden; touch-action: none; 
            user-select: none; -webkit-user-select: none; height: 100vh;
            display: flex; flex-direction: column;
        }
        
        canvas { 
            display: block; margin: 0; width: 100vw; height: auto;
            flex-grow: 1; background: #1a3c1a; image-rendering: auto;
        }

        /* --- HOME SCREEN --- */
        #startOverlay {
            position: fixed; inset: 0;
            background-image: url('background.png');
            background-size: cover; background-position: center;
            z-index: 1000; display: flex; flex-direction: column; 
            align-items: center; justify-content: center;
        }

        .forest-title {
            font-size: 58px; color: #4CAF50;
            text-shadow: 4px 4px 0px #1b5e20, 0 0 20px rgba(255,255,255,0.8); 
            margin: 0; line-height: 1.1; padding: 0 10px;
        }

        /* --- LOADING PIPELINE --- */
        #gameLoader {
            position: fixed; inset: 0; z-index: 5000;
            background: url('loadingbackgroundscreen.png') no-repeat center center;
            background-size: cover; display: none; /* Shown via JS */
            flex-direction: column; align-items: center; justify-content: center;
        }

        .pipeline-wrapper {
            position: relative; width: 80%; max-width: 650px; height: 100px; margin-top: 50px;
        }

        .log-container {
            position: absolute; inset: 0; background: var(--log-brown);
            border: 6px solid #5d4037; border-radius: 60px;
            box-shadow: inset 0 10px 20px rgba(0,0,0,0.8), 0 15px 30px rgba(0,0,0,0.6);
            overflow: hidden;
        }

        .log-texture {
            position: absolute; inset: 0;
            background: repeating-linear-gradient(90deg, transparent, transparent 40px, rgba(0,0,0,0.1) 41px, rgba(0,0,0,0.1) 45px);
            opacity: 0.4;
        }

        .energy-channel {
            position: absolute; top: 30px; left: 40px; right: 40px; bottom: 30px;
            background: rgba(0,0,0,0.6); border-radius: 30px;
            border: 2px solid rgba(118, 255, 235, 0.2); overflow: hidden;
        }

        .energy-fill {
            height: 100%; width: 0%; 
            background: linear-gradient(90deg, var(--deep-energy), var(--magic-teal), var(--deep-energy));
            background-size: 200% 100%; position: relative;
            box-shadow: 0 0 25px var(--magic-teal);
            transition: width 0.4s cubic-bezier(0.22, 1, 0.36, 1);
            animation: energy-flow 2s linear infinite;
        }

        .swirl-overlay {
            position: absolute; inset: 0;
            background: repeating-linear-gradient(45deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.1) 10%, transparent 10%, transparent 20%);
            mix-blend-mode: overlay; animation: swirl-move 3s linear infinite;
        }

        .newton-rider {
            position: absolute; left: 0%; top: -75px; width: 90px;
            transition: left 0.4s cubic-bezier(0.22, 1, 0.36, 1);
            z-index: 10; animation: newton-bob 1.5s ease-in-out infinite;
        }

        .newton-rider img { width: 100%; filter: drop-shadow(0 10px 10px rgba(0,0,0,0.5)); }

        /* --- UI BUTTONS --- */
        .top-btn {
            position: fixed; width: 35px; height: 35px; border: 2px solid #ffe066;
            border-radius: 50%; color: white; font-size: 16px; z-index: 2000;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
        }
        #skinBtn { top: 10px; right: 100px; background: radial-gradient(circle at 30% 30%, #ce93d8, #7b1fa2 80%); }
        #bgSwitchBtn { top: 10px; right: 55px; background: radial-gradient(circle at 30% 30%, #a5d6a7, #2E7D32 80%); }
        #muteBtn { top: 10px; right: 10px; background: radial-gradient(circle at 30% 30%, #90caf9, #1565c0 80%); }

        .main-btn {
            font-family: 'Luckiest Guy', cursive; font-size: 32px; padding: 15px 50px; 
            border-radius: 50px; border: 4px solid #ffe066; color: white; cursor: pointer;
            background: linear-gradient(#4CAF50, #2E7D32); box-shadow: 0 6px 0 #1B5E20; outline: none;
        }
        #reset { display: none; }

        #mobile-ui {
            background: linear-gradient(to top, #000, #1a3c1a);
            padding: 10px 10px 60px 10px; border-top: 4px solid #ffe066; z-index: 10;
        }
        #control-lane { display: flex; justify-content: space-around; max-width: 600px; margin: 0 auto 15px auto; }
        #leftBtn, #rightBtn { width: 85px; height: 85px; border-radius: 50%; background: #ff6b6b; font-size: 40px; color: white; border: 4px solid #ffe066; }

        /* --- ANIMATIONS --- */
        @keyframes energy-flow { from { background-position: 200% 0; } to { background-position: 0% 0; } }
        @keyframes swirl-move { from { transform: translateX(-50px); } to { transform: translateX(50px); } }
        @keyframes newton-bob { 0%, 100% { transform: translateY(0) rotate(-3deg); } 50% { transform: translateY(-12px) rotate(3deg); } }
    </style>
</head>

<body>
    <div id="skinBtn" class="top-btn">üëï</div>
    <div id="bgSwitchBtn" class="top-btn">üñºÔ∏è</div>
    <div id="muteBtn" class="top-btn">üîä</div>

    <div id="startOverlay">
        <h1 class="forest-title">NEWTON<br>AND<br>GRAVITY</h1>
        <div id="highScoreDisplay" style="color: #fff; font-size: 24px; margin: 15px 0;">BEST: 0</div>
        <button id="playBtn" class="main-btn">PLAY</button>
    </div>

    <div id="gameLoader">
        <h1 class="forest-title" style="color: var(--magic-teal);">LOADING...</h1>
        <div class="pipeline-wrapper">
            <div class="log-container">
                <div class="log-texture"></div>
            </div>
            <div class="energy-channel">
                <div id="energyFill" class="energy-fill">
                    <div class="swirl-overlay"></div>
                </div>
            </div>
            <div id="loadingNewton" class="newton-rider">
                <img src="newton.png" alt="Newton">
            </div>
        </div>
        <div id="loadStatus" style="margin-top:20px; color: var(--magic-teal);">STARTING FOREST... 0%</div>
    </div>

    <canvas id="game" width="1000" height="500"></canvas>

    <div id="mobile-ui">
        <div id="control-lane">
            <button id="leftBtn">‚óÄ</button>
            <button id="pauseBtn" class="main-btn" style="font-size: 18px; padding: 10px;">PAUSE</button>
            <button id="rightBtn">‚ñ∂</button>
        </div>
        <div id="reset-lane" style="height: 70px; display: flex; justify-content: center; align-items: center;">
            <button id="reset" class="main-btn">TRY AGAIN</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById("game");
        const ctx = canvas.getContext("2d");
        const isMobile = ('ontouchstart' in window) || navigator.maxTouchPoints > 0;
        if (!isMobile) document.getElementById("mobile-ui").style.display = "none";

        let images = {}, skins = [], currentBG;
        let bgMusic, sfxApple, sfxGolden, sfxBomb;
        const imageAssets = {
            border: 'border.png', bg1: 'background.png', bg2: 'background2.png',
            skin0: 'newton.png', skin1: 'newtonskin1.png', bomb: 'bomb.png',
            apple: 'apple.png', gApple: 'goldenapple.png'
        };

        function preloadEverything() {
            let loaded = 0;
            const total = Object.keys(imageAssets).length + 4;

            const updateProgress = () => {
                loaded++;
                let prog = (loaded / total) * 100;
                document.getElementById('energyFill').style.width = prog + '%';
                document.getElementById('loadingNewton').style.left = `calc(${prog}% - 45px)`;
                document.getElementById('loadStatus').innerText = `STARTING FOREST... ${Math.floor(prog)}%`;
                
                if (loaded === total) {
                    setTimeout(startGame, 800);
                }
            };

            Object.entries(imageAssets).forEach(([name, src]) => {
                images[name] = new Image();
                images[name].src = src;
                images[name].onload = updateProgress;
            });

            bgMusic = new Audio('background_music.mp3'); bgMusic.oncanplaythrough = updateProgress; bgMusic.loop = true;
            sfxApple = new Audio('apple.mp3'); sfxApple.oncanplaythrough = updateProgress;
            sfxGolden = new Audio('goldenapple.mp3'); sfxGolden.oncanplaythrough = updateProgress;
            sfxBomb = new Audio('bomb.mp3'); sfxBomb.oncanplaythrough = updateProgress;
        }

        let gameState = 'HOME', isPaused = false, isMuted = false, highScore = localStorage.getItem('newtonHighScore') || 0;
        document.getElementById('highScoreDisplay').innerText = "BEST: " + highScore;

        const nW = 315, nH = 144, iW = 85, iH = 50;  
        let newtonX = 425, appleX = 500, appleY = 0, score = 0, speed = 5.5, gameOver = false, isGolden = false, shake = 0, bombs = [];
        let explosion = { active: false, x: 0, y: 0, timer: 0 };
        const keys = { left: false, right: false }, L_LIMIT = 20, R_LIMIT = 980; 
        let bgScrollX = 0, currentSkinIndex = 0;

        function startGame() {
            document.getElementById('gameLoader').style.display = 'none';
            document.getElementById('reset').style.display = 'none';
            skins = [images.skin0, images.skin1];
            currentBG = currentBG || images.bg1;
            gameState = 'PLAYING';
            gameOver = false;
            if (!isMuted) { bgMusic.volume = 0.4; bgMusic.play().catch(()=>{}); }
            score = 0; speed = 5.5; newtonX = 425; bombs = []; explosion.active = false;
            resetApple(); gameLoop();
        }

        function triggerGameOver(exX, exY) {
            gameOver = true; shake = 35;
            explosion.active = true; explosion.x = exX; explosion.y = exY; explosion.timer = 30;
            if (!isMuted) { sfxBomb.currentTime = 0; sfxBomb.play(); }
            bgMusic.pause();
            document.getElementById('reset').style.display = 'block';
            if (score > highScore) { 
                highScore = score; localStorage.setItem('newtonHighScore', highScore); 
                document.getElementById('highScoreDisplay').innerText = "BEST: " + highScore;
            }
        }

        function resetApple() {
            appleY = -100; appleX = L_LIMIT + 100 + Math.random() * (R_LIMIT - L_LIMIT - 200);
            isGolden = Math.random() < 0.15;
        }

        function gameLoop() {
            if (gameState !== 'PLAYING' || isPaused) return;
            if (gameOver) {
                render();
                ctx.fillStyle = "rgba(0,0,0,0.6)"; ctx.fillRect(0,0,1000,500);
                ctx.fillStyle = "white"; ctx.font = "80px Luckiest Guy"; ctx.textAlign = "center";
                ctx.fillText("GAME OVER", 500, 250);
                return;
            }

            if (keys.left && newtonX > L_LIMIT) newtonX -= 15;
            if (keys.right && newtonX < R_LIMIT - nW) newtonX += 15;
            appleY += speed;

            if (appleY > 330 && appleY < 410 && appleX > newtonX + 20 && appleX < newtonX + nW - 20) {
                if (isGolden) { score += 5; if(!isMuted) sfxGolden.play(); } else { score += 1; if(!isMuted) sfxApple.play(); }
                speed += 0.08; resetApple();
            } else if (appleY > 480) {
                if (isGolden) resetApple(); else triggerGameOver(appleX, 450);
            }

            if (Math.random() < 0.007) bombs.push({ x: L_LIMIT + Math.random()*(R_LIMIT-L_LIMIT-iW), y: -100, s: 4 + Math.random()*2 });
            for (let i = bombs.length-1; i>=0; i--) {
                bombs[i].y += bombs[i].s;
                if (bombs[i].x + 40 > newtonX && bombs[i].x < newtonX + nW - 40 && bombs[i].y > 350) triggerGameOver(bombs[i].x, bombs[i].y);
                if (bombs[i].y > 500) bombs.splice(i,1);
            }

            render();
            requestAnimationFrame(gameLoop);
        }

        function render() {
            ctx.setTransform(1,0,0,1,0,0);
            if (shake > 0) { ctx.translate(Math.random()*shake - shake/2, Math.random()*shake - shake/2); shake *= 0.9; }
            ctx.clearRect(0,0,1000,500);
            let targetScroll = -(newtonX / R_LIMIT) * 300; bgScrollX += (targetScroll - bgScrollX) * 0.1;
            ctx.drawImage(currentBG, bgScrollX - 100, 0, 1300, 500);
            ctx.drawImage(skins[currentSkinIndex], newtonX, 340, nW, nH);
            if (!gameOver) ctx.drawImage(isGolden ? images.gApple : images.apple, appleX-42, appleY, iW, iH);
            bombs.forEach(b => ctx.drawImage(images.bomb, b.x, b.y, iW, iH));
            if (explosion.active) {
                ctx.font = `${80 + (30 - explosion.timer) * 3}px Arial`;
                ctx.fillText("üí•", explosion.x, explosion.y);
                explosion.timer--; if(explosion.timer <= 0) explosion.active = false;
            }
            ctx.fillStyle = "#5D2906"; ctx.fillRect(350, 10, 300, 40);
            ctx.fillStyle = "#ffe066"; ctx.font = "24px Luckiest Guy"; ctx.textAlign = "center";
            ctx.fillText("SCORE: " + score, 500, 38);
            ctx.drawImage(images.border, -10, -10, 1020, 520);
        }

        document.getElementById('playBtn').onclick = () => {
            document.getElementById('startOverlay').style.display = 'none';
            document.getElementById('gameLoader').style.display = 'flex';
            preloadEverything();
        };
        document.getElementById('reset').onclick = startGame;
        document.getElementById('skinBtn').onclick = () => currentSkinIndex = (currentSkinIndex + 1) % 2;
        document.getElementById('muteBtn').onclick = () => { isMuted = !isMuted; bgMusic.muted = isMuted; document.getElementById('muteBtn').innerText = isMuted ? "üîá" : "üîä"; };
        
        const handleMove = (id, k) => {
            const btn = document.getElementById(id);
            const start = (e) => { e.preventDefault(); keys[k] = true; };
            const end = (e) => { e.preventDefault(); keys[k] = false; };
            btn.addEventListener('touchstart', start); btn.addEventListener('touchend', end);
            btn.addEventListener('mousedown', start); btn.addEventListener('mouseup', end);
        };
        handleMove('leftBtn', 'left'); handleMove('rightBtn', 'right');
    </script>
</body>
</html>
