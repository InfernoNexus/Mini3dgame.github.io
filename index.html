<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Newton and Gravity</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Luckiest+Guy&display=swap');

        :root {
            --magic-teal: #76ffeb;
            --deep-energy: #1de9b6;
            --log-brown: #3e2723;
            --vibrant-gold: #ffd700;
        }

        body { 
            margin: 0; text-align: center; font-family: 'Luckiest Guy', cursive; 
            background: #0d1f0d; overflow: hidden; touch-action: none; 
            user-select: none; -webkit-user-select: none; height: 100vh;
            display: flex; flex-direction: column;
        }
        
        canvas { 
            display: block; margin: 0; width: 100vw; height: auto;
            flex-grow: 1; background: #1a3c1a; image-rendering: auto;
        }

        /* --- 3D MINI BUTTONS --- */
        .top-btn {
            position: fixed; width: 40px; height: 40px; border: 2px solid #ffe066;
            border-radius: 50%; color: white; font-size: 18px; z-index: 2000;
            display: none; align-items: center; justify-content: center; 
            cursor: pointer; top: 10px;
            transition: transform 0.05s;
        }
        #skinBtn { right: 110px; background: radial-gradient(circle at 30% 30%, #ce93d8, #7b1fa2 80%); box-shadow: 0 4px 0 #4a148c; }
        #bgSwitchBtn { right: 60px; background: radial-gradient(circle at 30% 30%, #a5d6a7, #2E7D32 80%); box-shadow: 0 4px 0 #1B5E20; }
        #muteBtn { right: 10px; background: radial-gradient(circle at 30% 30%, #90caf9, #1565c0 80%); box-shadow: 0 4px 0 #0d47a1; }

        .top-btn:active { transform: translateY(2px); box-shadow: 0 2px 0 rgba(0,0,0,0.5); }

        /* --- HOME SCREEN --- */
        #startOverlay {
            position: fixed; inset: 0;
            background-image: url('background.png');
            background-size: cover; background-position: center;
            z-index: 1000; display: flex; flex-direction: column; 
            align-items: center; justify-content: center;
        }

        .forest-title {
            font-size: 65px; 
            background: linear-gradient(to bottom, #ccff00 0%, #4CAF50 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: drop-shadow(4px 4px 0px #1b5e20);
            margin: 0; line-height: 1.0;
        }

        .best-score-vibrant {
            color: var(--vibrant-gold); font-size: 28px; margin: 20px 0;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.8), 2px 2px 2px #000;
            animation: pulse-gold 2s infinite;
        }

        /* --- 3D MAIN BUTTONS --- */
        .main-btn {
            font-family: 'Luckiest Guy', cursive; font-size: 32px; padding: 15px 50px; 
            border-radius: 50px; border: 4px solid #ffe066; color: white; cursor: pointer;
            background: linear-gradient(#4CAF50, #2E7D32); 
            box-shadow: 0 6px 0 #1B5E20; outline: none;
            position: relative; transition: all 0.1s;
        }
        
        .main-btn:active, .pressed-btn { 
            transform: translateY(4px); 
            box-shadow: 0 2px 0 #1B5E20; 
        }

        /* --- LOADING SCREEN --- */
        #gameLoader {
            position: fixed; inset: 0; z-index: 5000;
            background: url('loadingbackgroundscreen.png') no-repeat center center;
            background-size: cover; display: none;
            flex-direction: column; align-items: center; justify-content: center;
        }

        .pipeline-wrapper {
            position: relative; width: 80%; max-width: 650px; height: 100px; margin-top: 50px;
        }

        .log-container {
            position: absolute; inset: 0; background: var(--log-brown);
            border: 6px solid #5d4037; border-radius: 60px;
            box-shadow: inset 0 10px 20px rgba(0,0,0,0.8), 0 15px 30px rgba(0,0,0,0.6);
            overflow: hidden;
        }

        .energy-fill {
            height: 100%; width: 0%; 
            background: linear-gradient(90deg, var(--deep-energy), var(--magic-teal), var(--deep-energy));
            background-size: 200% 100%; position: relative;
            box-shadow: 0 0 25px var(--magic-teal);
            animation: energy-flow 2s linear infinite;
        }

        .newton-rider {
            position: absolute; left: 0%; top: -75px; width: 90px;
            z-index: 10; animation: newton-bob 1.5s ease-in-out infinite;
        }

        /* --- MOBILE UI & 3D CONTROLS --- */
        #mobile-ui {
            background: linear-gradient(to top, #000, #1a3c1a);
            padding: 10px 10px 60px 10px; border-top: 4px solid #ffe066; z-index: 10;
        }
        #control-lane { display: flex; justify-content: space-around; max-width: 600px; margin: 0 auto 15px auto; }
        
        #leftBtn, #rightBtn { 
            width: 85px; height: 85px; border-radius: 50%; 
            background: radial-gradient(circle at 30% 30%, #ff6b6b, #800000 80%); 
            font-size: 40px; color: white; border: 4px solid #ffe066;
            box-shadow: 0 6px 0 #550000; display: flex; align-items: center; justify-content: center;
            transition: transform 0.05s, box-shadow 0.05s;
        }
        
        #pauseBtn { 
            width: 75px; height: 75px; border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #ffd54f, #f57f17 80%); 
            border: 3px solid #ffe066; box-shadow: 0 5px 0 #bc5100;
            color: white; font-size: 14px; transition: transform 0.05s, box-shadow 0.05s;
        }

        /* Animation when button is physically held */
        .pressed { 
            transform: translateY(6px) !important; 
            box-shadow: 0 0px 0 #550000 !important; 
        }

        @keyframes energy-flow { from { background-position: 200% 0; } to { background-position: 0% 0; } }
        @keyframes newton-bob { 0%, 100% { transform: translateY(0) rotate(-3deg); } 50% { transform: translateY(-12px) rotate(3deg); } }
        @keyframes pulse-gold { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        @keyframes play-out { 0% { transform: scale(1); } 100% { transform: scale(1.2); opacity: 0; } }
    </style>
</head>

<body>
    <div id="skinBtn" class="top-btn">üëï</div>
    <div id="bgSwitchBtn" class="top-btn">üñºÔ∏è</div>
    <div id="muteBtn" class="top-btn">üîä</div>

    <div id="startOverlay">
        <h1 class="forest-title">NEWTON<br>AND<br>GRAVITY</h1>
        <div id="highScoreDisplay" class="best-score-vibrant">BEST: 0</div>
        <button id="playBtn" class="main-btn">PLAY</button>
    </div>

    <div id="gameLoader">
        <h1 class="forest-title" style="font-size: 40px; -webkit-text-fill-color: var(--magic-teal);">PREPARING...</h1>
        <div class="pipeline-wrapper">
            <div class="log-container"></div>
            <div class="energy-channel" style="position: absolute; top: 30px; left: 40px; right: 40px; bottom: 30px; background: rgba(0,0,0,0.6); border-radius: 30px; overflow: hidden;">
                <div id="energyFill" class="energy-fill"></div>
            </div>
            <div id="loadingNewton" class="newton-rider">
                <img src="newton.png" alt="Newton" style="width:100%;">
            </div>
        </div>
        <div id="loadStatus" style="margin-top:20px; color: var(--magic-teal);">0%</div>
    </div>

    <canvas id="game" width="1000" height="500"></canvas>

    <div id="mobile-ui">
        <div id="control-lane">
            <button id="leftBtn">‚óÄ</button>
            <button id="pauseBtn">PAUSE</button>
            <button id="rightBtn">‚ñ∂</button>
        </div>
        <div id="reset-lane" style="height: 70px; display: flex; justify-content: center; align-items: center;">
            <button id="reset" class="main-btn">TRY AGAIN</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById("game");
        const ctx = canvas.getContext("2d");
        const isMobile = ('ontouchstart' in window) || navigator.maxTouchPoints > 0;
        if (!isMobile) document.getElementById("mobile-ui").style.display = "none";

        let images = {}, skins = [], currentBG;
        let bgMusic, sfxApple, sfxGolden, sfxBomb;
        const imageAssets = {
            border: 'border.png', bg1: 'background.png', bg2: 'background2.png',
            skin0: 'newton.png', skin1: 'newtonskin1.png', bomb: 'bomb.png',
            apple: 'apple.png', gApple: 'goldenapple.png'
        };

        function showMiniButtons(show) {
            document.querySelectorAll('.top-btn').forEach(b => b.style.display = show ? 'flex' : 'none');
        }

        function preloadEverything() {
            let loaded = 0;
            const total = Object.keys(imageAssets).length + 4;
            showMiniButtons(false);

            const updateProgress = () => {
                loaded++;
                let prog = (loaded / total) * 100;
                document.getElementById('energyFill').style.width = prog + '%';
                document.getElementById('loadingNewton').style.left = `calc(${prog}% - 45px)`;
                document.getElementById('loadStatus').innerText = `${Math.floor(prog)}%`;
                if (loaded === total) setTimeout(startGame, 800);
            };

            Object.entries(imageAssets).forEach(([name, src]) => {
                images[name] = new Image(); images[name].src = src; images[name].onload = updateProgress;
            });
            bgMusic = new Audio('background_music.mp3'); bgMusic.oncanplaythrough = updateProgress; bgMusic.loop = true;
            sfxApple = new Audio('apple.mp3'); sfxApple.oncanplaythrough = updateProgress;
            sfxGolden = new Audio('goldenapple.mp3'); sfxGolden.oncanplaythrough = updateProgress;
            sfxBomb = new Audio('bomb.mp3'); sfxBomb.oncanplaythrough = updateProgress;
        }

        let gameState = 'HOME', isPaused = false, isMuted = false, highScore = localStorage.getItem('newtonHighScore') || 0;
        document.getElementById('highScoreDisplay').innerText = "BEST: " + highScore;

        const nW = 315, nH = 144, iW = 85, iH = 50;  
        let newtonX = 425, appleX = 500, appleY = 0, score = 0, speed = 5.5, gameOver = false, isGolden = false, shake = 0, bombs = [];
        let explosion = { active: false, x: 0, y: 0, timer: 0 };
        const keys = { left: false, right: false }, L_LIMIT = 20, R_LIMIT = 980; 
        let bgScrollX = 0, currentSkinIndex = 0;

        function startGame() {
            document.getElementById('gameLoader').style.display = 'none';
            document.getElementById('reset').style.display = 'none';
            showMiniButtons(true);
            skins = [images.skin0, images.skin1];
            currentBG = currentBG || images.bg1;
            gameState = 'PLAYING'; gameOver = false;
            if (!isMuted) { bgMusic.volume = 0.4; bgMusic.play().catch(()=>{}); }
            score = 0; speed = 5.5; newtonX = 425; bombs = []; explosion.active = false;
            resetApple(); gameLoop();
        }

        function triggerGameOver(exX, exY) {
            gameOver = true; shake = 35;
            explosion.active = true; explosion.x = exX; explosion.y = exY; explosion.timer = 30;
            if (!isMuted) { sfxBomb.currentTime = 0; sfxBomb.play(); }
            bgMusic.pause();
            document.getElementById('reset').style.display = 'block';
            if (score > highScore) { 
                highScore = score; localStorage.setItem('newtonHighScore', highScore); 
                document.getElementById('highScoreDisplay').innerText = "BEST: " + highScore;
            }
        }

        function resetApple() {
            appleY = -100; appleX = L_LIMIT + 100 + Math.random() * (R_LIMIT - L_LIMIT - 200);
            isGolden = Math.random() < 0.15;
        }

        function gameLoop() {
            if (gameState !== 'PLAYING' || isPaused) return;
            if (gameOver) {
                render(); ctx.fillStyle = "rgba(0,0,0,0.6)"; ctx.fillRect(0,0,1000,500);
                ctx.fillStyle = "white"; ctx.font = "80px Luckiest Guy"; ctx.textAlign = "center";
                ctx.fillText("GAME OVER", 500, 250); return;
            }
            if (keys.left && newtonX > L_LIMIT) newtonX -= 15;
            if (keys.right && newtonX < R_LIMIT - nW) newtonX += 15;
            appleY += speed;

            if (appleY > 330 && appleY < 410 && appleX > newtonX + 20 && appleX < newtonX + nW - 20) {
                if (isGolden) { score += 5; if(!isMuted) sfxGolden.play(); } else { score += 1; if(!isMuted) sfxApple.play(); }
                speed += 0.08; resetApple();
            } else if (appleY > 480) { if (isGolden) resetApple(); else triggerGameOver(appleX, 450); }

            if (Math.random() < 0.007) bombs.push({ x: L_LIMIT + Math.random()*(R_LIMIT-L_LIMIT-iW), y: -100, s: 4 + Math.random()*2 });
            for (let i = bombs.length-1; i>=0; i--) {
                bombs[i].y += bombs[i].s;
                if (bombs[i].x + 40 > newtonX && bombs[i].x < newtonX + nW - 40 && bombs[i].y > 350) triggerGameOver(bombs[i].x, bombs[i].y);
                if (bombs[i].y > 500) bombs.splice(i,1);
            }
            render(); requestAnimationFrame(gameLoop);
        }

        function render() {
            ctx.setTransform(1,0,0,1,0,0);
            if (shake > 0) { ctx.translate(Math.random()*shake - shake/2, Math.random()*shake - shake/2); shake *= 0.9; }
            ctx.clearRect(0,0,1000,500);
            let targetScroll = -(newtonX / R_LIMIT) * 300; bgScrollX += (targetScroll - bgScrollX) * 0.1;
            ctx.drawImage(currentBG, bgScrollX - 100, 0, 1300, 500);
            ctx.drawImage(skins[currentSkinIndex], newtonX, 340, nW, nH);
            if (!gameOver) ctx.drawImage(isGolden ? images.gApple : images.apple, appleX-42, appleY, iW, iH);
            bombs.forEach(b => ctx.drawImage(images.bomb, b.x, b.y, iW, iH));
            
            if (explosion.active) {
                ctx.font = `${80 + (30 - explosion.timer) * 3}px Arial`;
                ctx.fillText("üí•", explosion.x, explosion.y);
                explosion.timer--; if(explosion.timer <= 0) explosion.active = false;
            }

            // SCORE BOARD: ATTACHED TO TOP CENTER & FULLY VISIBLE
            ctx.save();
            ctx.fillStyle = "rgba(93, 41, 6, 0.95)"; ctx.strokeStyle = "#ffe066"; ctx.lineWidth = 4;
            ctx.beginPath(); ctx.roundRect(410, 15, 180, 45, 10); ctx.fill(); ctx.stroke();
            ctx.fillStyle = "#ffe066"; ctx.font = "24px Luckiest Guy"; ctx.textAlign = "center";
            ctx.fillText("SCORE: " + score, 500, 45); ctx.restore();

            ctx.drawImage(images.border, -25, -10, 1060, 530);
        }

        document.getElementById('playBtn').onclick = function() {
            this.style.animation = "play-out 0.4s forwards";
            setTimeout(() => {
                document.getElementById('startOverlay').style.display = 'none';
                document.getElementById('gameLoader').style.display = 'flex';
                preloadEverything();
            }, 400);
        };

        document.getElementById('reset').onclick = startGame;
        document.getElementById('skinBtn').onclick = () => currentSkinIndex = (currentSkinIndex + 1) % 2;
        document.getElementById('bgSwitchBtn').onclick = () => { currentBG = (currentBG === images.bg1) ? images.bg2 : images.bg1; };
        document.getElementById('muteBtn').onclick = () => { isMuted = !isMuted; if(bgMusic) bgMusic.muted = isMuted; document.getElementById('muteBtn').innerText = isMuted ? "üîá" : "üîä"; };
        
        const handleMove = (id, k) => {
            const btn = document.getElementById(id);
            const start = (e) => { e.preventDefault(); keys[k] = true; btn.classList.add('pressed'); };
            const end = (e) => { e.preventDefault(); keys[k] = false; btn.classList.remove('pressed'); };
            btn.addEventListener('touchstart', start); btn.addEventListener('touchend', end);
            btn.addEventListener('mousedown', start); btn.addEventListener('mouseup', end);
        };
        handleMove('leftBtn', 'left'); handleMove('rightBtn', 'right');
        
        document.getElementById('pauseBtn').onclick = function() {
            this.classList.add('pressed');
            setTimeout(() => this.classList.remove('pressed'), 100);
            isPaused = !isPaused; 
            this.innerText = isPaused ? "RESUME" : "PAUSE"; 
            if (!isPaused) gameLoop(); 
        };
    </script>
</body>
</html>
